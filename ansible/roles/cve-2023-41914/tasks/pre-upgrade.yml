- name: Stop slurmd
  systemd:
    name: slurmd
    state: stopped
  when: openhpc_enable.batch | default('false') | bool or 'login' in group_names

- name: Stop slurmctld
  systemd:
    name: slurmctld
    state: stopped
  when: openhpc_enable.control | default('false') | bool

- name: Stop slurmdbd
  systemd:
    name: slurmdbd
    state: stopped
  when: openhpc_enable.database | default('false') | bool

- name: Ensure backup directory exists
  file:
    path: "{{ cve_2023_41914_mysql_backup_path | dirname }}"
    state: directory
    owner: root
    group: root
  when: openhpc_enable.control | default(false) | bool

- name: Ensure mysqldump tool installed
  dnf:
    name: mysql
  when: openhpc_enable.control | default(false) | bool

- name: Backup database
  community.mysql.mysql_db:
    name: slurm_acct_db
    state: dump
    target: "{{ cve_2023_41914_mysql_backup_path }}"
    login_user: root
    login_password: "{{ mysql_root_password }}"
    login_host: "{{ mysql_host }}"
  when: openhpc_enable.control | default(false) | bool
